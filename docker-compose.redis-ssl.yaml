# Docker Compose with SSL-enabled Redis for local development
# Usage: docker-compose -f docker-compose.redis-ssl.yaml up -d

services:
  redis-ssl:
    image: redis:7-alpine
    restart: unless-stopped
    ports:
      - "6380:6380" # SSL port
    volumes:
      - redis_ssl_data:/data
      - ./secrets/redis-certs:/certs:ro
    command: >
      redis-server
      --port 0
      --tls-port 6380
      --tls-cert-file /certs/redis-server-cert.pem
      --tls-key-file /certs/redis-server-key.pem
      --tls-ca-cert-file /certs/ca-cert.pem
      --tls-protocols "TLSv1.2 TLSv1.3"
      --requirepass dev-password
      --appendonly yes
    healthcheck:
      test:
        [
          "CMD",
          "redis-cli",
          "--tls",
          "--cacert",
          "/certs/ca-cert.pem",
          "-a",
          "dev-password",
          "ping",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - baliblissed-network

  backend:
    build:
      context: .
      dockerfile: ./Dockerfile
    ports:
      - "8000:8000"
    volumes:
      - ./secrets/token.json:/app/secrets/token.json:ro
      - ./secrets/client_secret.json:/app/secrets/client_secret.json:ro
      - ./secrets/redis-certs:/app/secrets/redis-certs:ro
    environment:
      - REDIS_HOST=redis-ssl
      - REDIS_PORT=6380
      - REDIS_PASSWORD=dev-password
      - REDIS_SSL=true
      - REDIS_SSL_CA_CERTS=/app/secrets/redis-certs/ca-cert.pem
      # For mTLS (optional):
      # - REDIS_SSL_CERTFILE=/app/secrets/redis-certs/redis-client-cert.pem
      # - REDIS_SSL_KEYFILE=/app/secrets/redis-certs/redis-client-key.pem
    depends_on:
      redis-ssl:
        condition: service_healthy
    networks:
      - baliblissed-network

volumes:
  redis_ssl_data:
    driver: local

networks:
  baliblissed-network:
    driver: bridge
