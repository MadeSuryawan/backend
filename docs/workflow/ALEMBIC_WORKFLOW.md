# Alembic Database Migration Workflow

A practical guide for day-to-day development with Alembic migrations in the BaliBlissed Backend.

---

## Quick Reference

```bash
# Most common commands
./scripts/migrate.sh upgrade          # Apply all pending migrations
./scripts/migrate.sh current          # Check current database revision
./scripts/migrate.sh generate "msg"   # Create new migration after model changes
./scripts/migrate.sh check            # Verify no pending migrations
```

---

## Daily Development Workflow

### Starting a New Feature

1. **Pull latest changes and apply migrations**

   ```bash
   git pull origin main
   ./scripts/migrate.sh upgrade
   ```

2. **Verify database is up-to-date**

   ```bash
   ./scripts/migrate.sh current
   # Should show: 0001 (head)
   ```

3. **Start developing your feature**

---

### Making Model Changes

When you modify SQLModel classes in `app/models/`:

1. **Make your model changes**

   ```python
   # app/models/user.py
   class UserDB(SQLModel, table=True):
       # ... existing fields ...
       new_field: str | None = Field(default=None, sa_column=Column(String(100)))
   ```

2. **Generate migration automatically**

   ```bash
   ./scripts/migrate.sh generate "add_new_field_to_users"
   ```

3. **Review the generated migration**

   ```bash
   # Check the new file in alembic/versions/
   cat alembic/versions/*_add_new_field_to_users.py
   ```

   ⚠️ **ALWAYS review autogenerated migrations!** They may need adjustments.

4. **Apply the migration**

   ```bash
   ./scripts/migrate.sh upgrade
   ```

5. **Test the downgrade (optional but recommended)**

   ```bash
   ./scripts/migrate.sh downgrade -1
   ./scripts/migrate.sh upgrade
   ```

---

### Before Committing

```bash
# Ensure migrations are applied
./scripts/migrate.sh check

# Run tests to verify schema is correct
uv run pytest tests/ -v

# Commit your changes including migrations
git add alembic/versions/*.py app/models/
git commit -m "feat: add new_field to users table"
```

---

## Common Scenarios

### Scenario 1: Fresh Clone / New Developer Setup

```bash
# 1. Clone the repository
git clone <repo-url>
cd backend

# 2. Install dependencies
uv sync

# 3. Set up database connection in secrets/.env
echo 'DATABASE_URL=postgresql+asyncpg://user:pass@localhost:5432/baliblissed' >> secrets/.env

# 4. Apply all migrations
./scripts/migrate.sh upgrade

# 5. Verify
./scripts/migrate.sh current
```

### Scenario 2: Existing Database from Before Alembic

If you have a database created with the old `create_all()` method:

```bash
# 1. Stamp the database with the initial migration
# This tells Alembic the schema is already at this version
./scripts/migrate.sh stamp 0001

# 2. Verify
./scripts/migrate.sh current
# Should show: 0001 (head)
```

### Scenario 3: Merge Conflict in Migrations

If multiple developers create migrations simultaneously:

```bash
# 1. Pull the latest changes
git pull origin main

# 2. If there are multiple heads, merge them
uv run alembic merge -m "merge_heads" <rev1> <rev2>

# 3. Apply the merged migration
./scripts/migrate.sh upgrade
```

### Scenario 4: Rolling Back a Bad Migration

```bash
# 1. Downgrade one step
./scripts/migrate.sh downgrade -1

# 2. Fix the migration file or delete it
rm alembic/versions/<bad_migration>.py

# 3. Regenerate if needed
./scripts/migrate.sh generate "fixed_migration"

# 4. Apply
./scripts/migrate.sh upgrade
```

### Scenario 5: Generating SQL for DBA Review

For production deployments requiring DBA approval:

```bash
# Generate SQL without executing
./scripts/migrate.sh sql

# Or for specific revision range
uv run alembic upgrade <from_rev>:<to_rev> --sql > migration.sql
```

---

## Migration Script Commands

| Command           | Description                                     |
| ----------------- | ----------------------------------------------- |
| `upgrade [rev]`   | Upgrade database to revision (default: head)    |
| `downgrade [rev]` | Downgrade database to revision (default: -1)    |
| `current`         | Show current database revision                  |
| `history`         | Show all migration history                      |
| `heads`           | Show current head revisions                     |
| `generate <msg>`  | Generate new migration with autogenerate        |
| `stamp <rev>`     | Mark database as specific revision (no changes) |
| `check`           | Check for pending migrations                    |
| `sql [rev]`       | Generate SQL without executing                  |
| `reset`           | Full reset: downgrade to base, upgrade to head  |

---

## Best Practices

### DO ✅

- **Always review autogenerated migrations** before applying
- **Test downgrades** to ensure they work correctly
- **Keep migrations atomic** - one logical change per migration
- **Use descriptive migration names**: `add_role_column_to_users` not `update`
- **Commit migrations with related code changes**
- **Run migrations in CI/CD** to catch issues early
- **Back up production database** before applying migrations

### DON'T ❌

- **Never edit a migration that's already been applied** to shared databases
- **Never delete migrations** that others have applied
- **Never manually modify database schema** without a migration
- **Don't combine unrelated changes** in one migration
- **Don't skip migration review** even for simple changes

---

## Troubleshooting

### "Target database is not up to date"

```bash
./scripts/migrate.sh upgrade
```

### "Can't locate revision"

The database references a revision that doesn't exist:

```bash
# Check what revision the DB thinks it's at
./scripts/migrate.sh current

# If revision file was deleted, stamp with correct revision
./scripts/migrate.sh stamp <correct_revision>
```

### "Multiple heads detected"

Multiple unmerged migration branches exist:

```bash
# View the heads
./scripts/migrate.sh heads

# Merge them
uv run alembic merge -m "merge_heads" head
./scripts/migrate.sh upgrade
```

### "Autogenerate not detecting changes"

Ensure models are imported in `alembic/env.py`:

```python
# alembic/env.py
from app.models import BlogDB, UserDB  # noqa: F401
```

### "Connection refused"

Database not running or wrong connection string:

```bash
# Check DATABASE_URL in secrets/.env
cat secrets/.env | grep DATABASE_URL

# Ensure PostgreSQL is running
docker compose up -d  # if using Docker
```

---

## File Structure

```plain text
backend/
├── alembic/
│   ├── env.py              # Migration environment configuration
│   ├── script.py.mako      # Template for new migrations
│   ├── README              # Alembic readme
│   └── versions/           # Migration files
│       └── 20251215_0001_initial_schema.py
├── alembic.ini             # Alembic configuration
├── scripts/
│   └── migrate.sh          # Migration helper script
└── app/
    └── models/             # SQLModel definitions
        ├── user.py
        └── blog.py
```

---

## Production Deployment Notes

### Pre-Deployment Checklist

- [ ] All migrations tested locally
- [ ] Downgrade tested
- [ ] Database backed up
- [ ] Migration SQL reviewed (if required)
- [ ] Deployment window scheduled (for long-running migrations)

### Docker Deployment

The Dockerfile automatically runs migrations before starting the app:

```dockerfile
CMD ["sh", "-c", "alembic upgrade head && uvicorn app.main:app ..."]
```

### Manual Production Deployment

```bash
# 1. Backup database
pg_dump -h host -U user -d dbname > backup_$(date +%Y%m%d_%H%M%S).sql

# 2. Apply migrations
./scripts/migrate.sh upgrade

# 3. Verify
./scripts/migrate.sh current

# 4. Start/restart application
```

---

## Environment Variables

| Variable       | Description                  | Example                                            |
| -------------- | ---------------------------- | -------------------------------------------------- |
| `DATABASE_URL` | PostgreSQL connection string | `postgresql+asyncpg://user:pass@localhost:5432/db` |

Ensure `DATABASE_URL` is set in `secrets/.env` or as an environment variable.

---

## Additional Resources

- [Alembic Documentation](https://alembic.sqlalchemy.org/en/latest/)
- [SQLModel Tutorial](https://sqlmodel.tiangolo.com/)
- [ALEMBIC_DATABASE_MIGRATION_PLAN.md](./ALEMBIC_DATABASE_MIGRATION_PLAN.md) - Implementation details

---
